<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Streams - Yoto Smart Stream</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Stream audio to Yoto devices with MQTT monitoring and interactive audio experiences">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Yoto Stream">

    <!-- PWA Icons and Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">

    <link rel="stylesheet" href="/static/css/style.css?v=20260114-2">
    <link rel="stylesheet" href="/static/css/modern-enhancements.css?v=20260119-1">
    <link rel="stylesheet" href="/static/css/pwa.css">
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <h1>üéµ Yoto Stream</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="/">üè† Dashboard</a></li>
            <li class="active"><a href="/streams">‚ú® Smart Streams</a></li>
            <li><a href="/library">üìö Yoto Library</a></li>
            <li><a href="/audio-library">üéôÔ∏è Audio Library</a></li>
            <li><a href="/admin">‚öôÔ∏è Admin</a></li>
        </ul>
        <div class="sidebar-footer">
            <p id="app-version">Loading...</p>
        </div>
    </nav>

    <main class="content">
        <header>
            <h2>Smart Streams</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button class="refresh-btn" onclick="loadAudioFiles()">üîÑ Refresh</button>
            </div>
        </header>

        <section class="section">
            <div class="stream-info">
                <p>Available audio streams from this server. These URLs can be used in Yoto MYO cards.</p>
                <p class="public-url" id="public-url">Server URL: <span id="url-display">Loading...</span></p>
            </div>
        </section>

        <section class="section">
            <h3>Available Audio Files</h3>
            <div id="audio-streams" class="streams-grid">
                <p class="loading">Loading audio files...</p>
            </div>
        </section>

        <section class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h3>Managed Streams</h3>
                    <p class="info-text">Server-controlled playlists that stream multiple files sequentially.</p>
                </div>
                <button class="btn-primary" onclick="openStreamScripter()">üé¨ Stream Scripter</button>
            </div>
            <div id="managed-streams" class="streams-grid">
                <p class="loading">Loading managed streams...</p>
            </div>
        </section>
    </main>

    <!-- Audio Player Modal -->
    <div id="audio-player-modal" class="modal" style="display: none;">
        <div class="modal-content audio-player">
            <div class="player-header">
                <h3 id="player-title">Audio Preview</h3>
                <button class="close-btn" onclick="closeAudioPlayer()">‚úï</button>
            </div>
            <div class="player-body">
                <audio id="audio-element" controls style="width: 100%;">
                    <source id="audio-source" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <p id="player-url" class="player-url"></p>
            </div>
        </div>
    </div>

    <!-- Stream Scripter Modal -->
    <div id="stream-scripter-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üé¨ Stream Scripter</h3>
                <button class="close-btn" onclick="closeStreamScripter()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="queue-selector">Queue</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="queue-selector" style="flex: 1;">
                            <option value="">-- Select Queue --</option>
                        </select>
                        <button class="btn-secondary" onclick="startNewQueue()">New Queue</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="queue-name">Queue Name</label>
                    <input type="text" id="queue-name" placeholder="my-awesome-queue" pattern="[a-zA-Z0-9\-]+" required>
                    <small style="color: #666;">Only alphanumeric characters and hyphens allowed</small>
                </div>

                <!-- Card Metadata Section -->
                <div class="form-section" style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">üìã Card Metadata</h4>

                    <div class="form-group">
                        <label for="card-title">Card Title</label>
                        <input type="text" id="card-title" placeholder="My Awesome Playlist">
                        <small style="color: #666;">The title shown in your Yoto library (defaults to queue name)</small>
                    </div>

                    <div class="form-group">
                        <label for="card-description">Description</label>
                        <textarea id="card-description" rows="3" placeholder="A wonderful collection of stories and songs..."></textarea>
                        <small style="color: #666;">Optional description for your card</small>
                    </div>

                    <div class="form-group">
                        <label for="card-author">Author</label>
                        <input type="text" id="card-author" placeholder="Yoto Smart Stream">
                        <small style="color: #666;">Who created this content</small>
                    </div>

                    <div class="form-group">
                        <label for="card-cover-image">Cover Image</label>
                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="file" id="card-cover-image" accept="image/*" onchange="previewCoverImage(this)">
                                <small style="color: #666; display: block; margin-top: 0.25rem;">Upload a cover image for your card</small>
                            </div>
                            <div id="cover-image-preview" style="display: none; width: 80px; height: 80px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                                <img id="cover-image-preview-img" src="" alt="Cover preview" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        </div>
                        <div id="cover-image-status" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 4px; font-size: 0.9rem;"></div>
                    </div>

                    <!-- Future: Ambient Colors -->
                    <!-- TODO: Add hex color picker for chapter/track ambient lighting
                         Example: <input type="color" id="default-ambient" value="#FF6B6B">
                         See Yoto API docs for ambient field on chapters/tracks -->

                    <!-- Future: Interactive Card Mode -->
                    <!-- TODO: Add toggle for interactive cards with event configuration
                         Requires: onLhb, onRhb, onEnd event handlers for branching narratives
                         See INTERACTIVE_CARD_ANALYSIS.md for implementation patterns -->
                </div>

                <div class="form-group">
                    <label>Available Files</label>
                    <div id="file-selector" class="file-selector-grid">
                        <p class="loading">Loading files...</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Chapters & Tracks (<span id="queue-count">0</span> chapters)</label>
                    <small style="color: #666; display: block; margin-bottom: 0.5rem;">
                        Click chapter titles to edit. Click "+" to add tracks to a chapter.
                        <!-- Future: Multi-track chapters allow multiple audio files per chapter section -->
                    </small>
                    <div id="queue-list" class="queue-list">
                        <p style="color: #999; text-align: center; padding: 2rem;">No files added yet. Select files above to add them.</p>
                    </div>
                </div>

                <div id="scripter-result" class="result-message" style="display: none;"></div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="saveQueue()">Save Queue</button>
                    <button class="btn-primary" onclick="createCardFromQueue()" style="margin-left: 0.5rem;">Create Card</button>
                    <button id="delete-queue-btn" class="btn-danger" onclick="confirmDeleteQueue()" style="display: none;">Delete Queue</button>
                    <button class="btn-secondary" onclick="clearQueueSelection()">Clear Selection</button>
                    <button class="btn-secondary" onclick="closeStreamScripter()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div id="create-playlist-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìã Create Playlist</h3>
                <button class="close-btn" onclick="closePlaylistModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="playlist-stream-selector">Select Stream</label>
                    <select id="playlist-stream-selector" required>
                        <option value="">-- Select a stream --</option>
                    </select>
                    <small style="color: #666;">Choose a managed stream to link to the playlist</small>
                </div>

                <div class="form-group">
                    <label for="playlist-name">Playlist Name</label>
                    <input type="text" id="playlist-name" required placeholder="My Custom Playlist">
                    <small style="color: #666;">This will be the name shown in your Yoto library</small>
                </div>

                <div id="playlist-result" class="result-message" style="display: none;"></div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="createPlaylist()">Create Playlist</button>
                    <button class="btn-secondary" onclick="closePlaylistModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/streams.js"></script>
    <script src="/static/js/pwa.js"></script>
    <script>
        // Hide admin nav for non-admin users
        async function checkAdminStatusNav() {
            try {
                const response = await fetch('/api/user/session', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (!data.is_admin) {
                        const adminLink = document.querySelector('a[href="/admin"]');
                        if (adminLink) {
                            adminLink.parentElement.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }
        checkAdminStatusNav();
    </script>
    
    <!-- Dark Mode Support -->
    <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
    <script>
        const darkmode = new Darkmode({
            bottom: '64px',
            right: '32px',
            left: 'unset',
            time: '0.3s',
            mixColor: '#fff',
            backgroundColor: '#f8fafc',
            buttonColorDark: '#0891b2',
            buttonColorLight: '#06b6d4',
            saveInCookies: true,
            label: 'üåì',
            autoMatchOsTheme: true
        });
        darkmode.showWidget();
    </script>
</body>
</html>
