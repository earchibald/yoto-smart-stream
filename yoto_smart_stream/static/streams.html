<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Streams - Yoto Smart Stream</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Stream audio to Yoto devices with MQTT monitoring and interactive audio experiences">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Yoto Stream">

    <!-- PWA Icons and Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">

    <link rel="stylesheet" href="/static/css/style.css?v=20260114-2">
    <link rel="stylesheet" href="/static/css/modern-enhancements.css?v=20260119-1">
    <link rel="stylesheet" href="/static/css/pwa.css">
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <h1>üéµ Yoto Stream</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="/">üè† Dashboard</a></li>
            <li class="active"><a href="/streams">‚ú® Smart Streams</a></li>
            <li><a href="/library">üìö Yoto Library</a></li>
            <li><a href="/audio-library">üéôÔ∏è Audio Library</a></li>
            <li><a href="/admin">‚öôÔ∏è Admin</a></li>
        </ul>
        <div class="sidebar-footer">
            <p id="app-version">Loading...</p>
        </div>
    </nav>

    <main class="content">
        <header>
            <h2>Smart Streams</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button class="refresh-btn" onclick="loadAudioFiles()">üîÑ Refresh</button>
            </div>
        </header>

        <section class="section">
            <div class="stream-info">
                <p>Available audio streams from this server. These URLs can be used in Yoto MYO cards.</p>
                <p class="public-url" id="public-url">Server URL: <span id="url-display">Loading...</span></p>
            </div>
        </section>

        <section class="section">
            <h3>Available Audio Files</h3>
            <div id="audio-streams" class="streams-grid">
                <p class="loading">Loading audio files...</p>
            </div>
        </section>

        <section class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h3>Managed Streams</h3>
                    <p class="info-text">Server-controlled playlists that stream multiple files sequentially.</p>
                </div>
                <button class="btn-primary" onclick="openStreamScripter()">üé¨ Stream Scripter</button>
            </div>
            <div id="managed-streams" class="streams-grid">
                <p class="loading">Loading managed streams...</p>
            </div>
        </section>
    </main>

    <!-- Audio Player Modal -->
    <div id="audio-player-modal" class="modal" style="display: none;">
        <div class="modal-content audio-player">
            <div class="player-header">
                <h3 id="player-title">Audio Preview</h3>
                <button class="close-btn" onclick="closeAudioPlayer()">‚úï</button>
            </div>
            <div class="player-body">
                <audio id="audio-element" controls style="width: 100%;">
                    <source id="audio-source" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <p id="player-url" class="player-url"></p>
            </div>
        </div>
    </div>

    <!-- Stream Scripter Modal -->
    <div id="stream-scripter-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üé¨ Stream Scripter</h3>
                <button class="close-btn" onclick="closeStreamScripter()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="queue-selector">
                        Load Existing Stream
                        <button class="help-icon-btn" onclick="openStreamScripterHelp()" title="Help - Stream Scripter Guide">‚ùì</button>
                    </label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="queue-selector" style="flex: 1;">
                            <option value="">-- Create New or Select Existing --</option>
                        </select>
                        <button class="btn-secondary" onclick="startNewQueue()">+ New Stream</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="queue-name">Stream ID (URL-friendly name)</label>
                    <input type="text" id="queue-name" placeholder="my-awesome-stream" pattern="[a-zA-Z0-9\-]+" required>
                    <small style="color: #666;">Only alphanumeric characters and hyphens allowed. This becomes the URL path.</small>
                </div>

                <!-- Card Metadata Section -->
                <div class="form-section" style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">üìã Card Metadata</h4>

                    <div class="form-group">
                        <label for="card-title">Card Title</label>
                        <input type="text" id="card-title" placeholder="My Awesome Playlist">
                        <small style="color: #666;">The title shown in your Yoto library (defaults to queue name)</small>
                    </div>

                    <div class="form-group">
                        <label for="card-description">Description</label>
                        <textarea id="card-description" rows="3" placeholder="A wonderful collection of stories and songs..."></textarea>
                        <small style="color: #666;">Optional description for your card</small>
                    </div>

                    <div class="form-group">
                        <label for="card-author">Author</label>
                        <input type="text" id="card-author" placeholder="Yoto Smart Stream">
                        <small style="color: #666;">Who created this content</small>
                    </div>

                    <div class="form-group">
                        <label for="card-cover-image">Cover Image</label>
                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="file" id="card-cover-image" accept="image/*" onchange="previewCoverImage(this)">
                                <small style="color: #666; display: block; margin-top: 0.25rem;">Upload a cover image for your card</small>
                            </div>
                            <div id="cover-image-preview" style="display: none; width: 80px; height: 80px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                                <img id="cover-image-preview-img" src="" alt="Cover preview" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        </div>
                        <div id="cover-image-status" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 4px; font-size: 0.9rem;"></div>
                    </div>

                    <!-- Future: Ambient Colors -->
                    <!-- TODO: Add hex color picker for chapter/track ambient lighting
                         Example: <input type="color" id="default-ambient" value="#FF6B6B">
                         See Yoto API docs for ambient field on chapters/tracks -->

                    <!-- Future: Interactive Card Mode -->
                    <!-- TODO: Add toggle for interactive cards with event configuration
                         Requires: onLhb, onRhb, onEnd event handlers for branching narratives
                         See INTERACTIVE_CARD_ANALYSIS.md for implementation patterns -->
                </div>

                <div class="form-group">
                    <label>Available Files</label>
                    <div id="file-selector" class="file-selector-grid">
                        <p class="loading">Loading files...</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Chapters & Tracks (<span id="queue-count">0</span> chapters)</label>
                    <small style="color: #666; display: block; margin-bottom: 0.5rem;">
                        Click chapter titles to edit. Click "+" to add tracks to a chapter.
                        <!-- Future: Multi-track chapters allow multiple audio files per chapter section -->
                    </small>
                    <div id="queue-list" class="queue-list">
                        <p style="color: #999; text-align: center; padding: 2rem;">No files added yet. Select files above to add them.</p>
                    </div>
                </div>

                <div id="scripter-result" class="result-message" style="display: none;"></div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="saveQueue()">Save Queue</button>
                    <button class="btn-primary" onclick="createCardFromQueue()" style="margin-left: 0.5rem;">Create Card</button>
                    <button id="delete-queue-btn" class="btn-danger" onclick="confirmDeleteQueue()" style="display: none;">Delete Queue</button>
                    <button class="btn-secondary" onclick="clearQueueSelection()">Clear Selection</button>
                    <button class="btn-secondary" onclick="closeStreamScripter()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div id="create-playlist-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìã Create Playlist</h3>
                <button class="close-btn" onclick="closePlaylistModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="playlist-stream-selector">Select Stream</label>
                    <select id="playlist-stream-selector" required>
                        <option value="">-- Select a stream --</option>
                    </select>
                    <small style="color: #666;">Choose a managed stream to link to the playlist</small>
                </div>

                <div class="form-group">
                    <label for="playlist-name">Playlist Name</label>
                    <input type="text" id="playlist-name" required placeholder="My Custom Playlist">
                    <small style="color: #666;">This will be the name shown in your Yoto library</small>
                </div>

                <div id="playlist-result" class="result-message" style="display: none;"></div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="createPlaylist()">Create Playlist</button>
                    <button class="btn-secondary" onclick="closePlaylistModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stream Scripter Help Modal -->
    <div id="stream-scripter-help-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>üé¨ Stream Scripter Help</h3>
                <button class="close-btn" onclick="closeStreamScripterHelp()">‚úï</button>
            </div>
            <div style="padding: 0 1.5rem 0.5rem;">
                <input
                    type="text"
                    id="help-search-input"
                    placeholder="Search help... (press '/' to focus)"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;"
                    oninput="searchHelpContent(this.value)"
                >
                <div id="help-search-status" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666; display: none;">
                    <span id="help-match-count">0</span> matches found
                    <span id="help-nav-controls" style="margin-left: 1rem; display: none;">
                        <button onclick="navigateHelpMatches('prev')" style="padding: 0.25rem 0.5rem; margin: 0 0.25rem;">‚Üê Prev</button>
                        <span id="help-match-position">1 / 1</span>
                        <button onclick="navigateHelpMatches('next')" style="padding: 0.25rem 0.5rem; margin: 0 0.25rem;">Next ‚Üí</button>
                    </span>
                </div>
            </div>
            <div class="modal-body" id="help-modal-content" style="overflow-y: auto; flex: 1;">
                <div id="help-content">
                    <h3>What is Stream Scripter?</h3>
                    <p>Stream Scripter is a powerful tool for creating custom audio streams (playlists) that can be played on your Yoto devices. Think of it as a playlist builder that creates streaming URLs you can use in Yoto MYO (Make Your Own) cards.</p>

                    <h3>Key Concepts</h3>

                    <h4>Stream (formerly "Queue")</h4>
                    <p>A stream is a named collection of audio files that play sequentially. Each stream has a unique ID that becomes part of its URL. For example, a stream named "bedtime-stories" creates the URL: <code>/api/streams/bedtime-stories/stream.mp3</code></p>

                    <h4>Stream ID</h4>
                    <p>The URL-friendly identifier for your stream. It can only contain letters, numbers, and hyphens. This ID is used in the streaming URL that clients (like Yoto players) use to access your audio.</p>

                    <h4>Chapters & Tracks</h4>
                    <p>Each audio file in your stream becomes a chapter in the Yoto card. You can customize chapter titles to make them more meaningful than the original filenames.</p>

                    <h4>Card Metadata</h4>
                    <p>When you create a Yoto card from your stream, you can set:</p>
                    <ul>
                        <li><strong>Title:</strong> The name shown in your Yoto library</li>
                        <li><strong>Description:</strong> Additional details about the content</li>
                        <li><strong>Author:</strong> Content creator name</li>
                        <li><strong>Cover Image:</strong> Custom artwork for your card</li>
                    </ul>

                    <h3>How to Use Stream Scripter</h3>

                    <h4>Creating a New Stream</h4>
                    <ol>
                        <li>Click "üé¨ Stream Scripter" button on the Streams page</li>
                        <li>The "Stream ID" field will be auto-populated with a random name like "stream-abc123"</li>
                        <li>Change the Stream ID to something memorable (e.g., "kids-bedtime-stories")</li>
                        <li>Select audio files from the "Available Files" section by checking the boxes</li>
                        <li>Files appear in the "Chapters & Tracks" section below</li>
                        <li>Click chapter titles to edit them (they default to filename without extension)</li>
                        <li>Drag files to reorder them, or use ‚Üë‚Üì buttons</li>
                        <li>Fill in Card Metadata fields if you plan to create a Yoto card</li>
                        <li>Click "Save Stream" to save just the streaming playlist</li>
                        <li>Or click "Create Card" to both save the stream AND create a Yoto card</li>
                    </ol>

                    <h4>Editing an Existing Stream</h4>
                    <ol>
                        <li>Open Stream Scripter</li>
                        <li>Use the "Load Existing Stream" dropdown to select a stream</li>
                        <li>The stream's files and settings will load</li>
                        <li>Make your changes</li>
                        <li>Click "Save Stream" to update</li>
                    </ol>

                    <h4>Play Modes</h4>
                    <p>After creating a stream, you can set how it plays on the Streams page:</p>
                    <ul>
                        <li><strong>üìª Sequential:</strong> Play files in order, once through</li>
                        <li><strong>üîÅ Loop:</strong> Repeat the playlist indefinitely</li>
                        <li><strong>üîÄ Shuffle:</strong> Random order, once through</li>
                        <li><strong>‚ôæÔ∏è Endless Shuffle:</strong> Random order, repeating forever</li>
                    </ul>

                    <h3>Working with Audio Files</h3>

                    <h4>File Requirements</h4>
                    <ul>
                        <li>Format: MP3 (recommended 128-256 kbps)</li>
                        <li>Files must be uploaded to the server first (via Audio Library)</li>
                        <li>Use descriptive filenames - they become default chapter titles</li>
                    </ul>

                    <h4>Organizing Your Stream</h4>
                    <ul>
                        <li>Drag and drop files to reorder them</li>
                        <li>Use the ‚úï button to remove files</li>
                        <li>Click chapter titles to rename them</li>
                        <li>Add multiple files at once by checking several boxes</li>
                    </ul>

                    <h3>Creating Yoto Cards</h3>

                    <h4>Two Ways to Create Cards</h4>
                    <ol>
                        <li><strong>From Stream Scripter:</strong> Click "Create Card" button after setting up your stream and metadata</li>
                        <li><strong>From Streams Page:</strong> Click "üìã Create Playlist" on any existing stream card</li>
                    </ol>

                    <h4>Card Creation Tips</h4>
                    <ul>
                        <li>Use meaningful chapter titles - they appear in the Yoto app</li>
                        <li>Add a cover image for visual appeal (max 5MB)</li>
                        <li>Write a clear description to help identify the content later</li>
                        <li>The author field helps you track who created the content</li>
                    </ul>

                    <h3>Advanced Features</h3>

                    <h4>Cover Images</h4>
                    <ul>
                        <li>Upload images up to 5MB</li>
                        <li>Supported formats: JPG, PNG, GIF</li>
                        <li>Square images work best</li>
                        <li>Images are uploaded to Yoto's servers when you create a card</li>
                    </ul>

                    <h4>Stream URLs</h4>
                    <p>After saving a stream, its URL will be: <code>/api/streams/[your-stream-id]/stream.mp3</code></p>
                    <p>You can use this URL in:</p>
                    <ul>
                        <li>Yoto MYO cards directly</li>
                        <li>External audio players (for testing)</li>
                        <li>Custom integrations</li>
                    </ul>

                    <h4>Reserved Streams</h4>
                    <p>Some stream names are reserved for system use:</p>
                    <ul>
                        <li><strong>test-stream:</strong> Built-in test stream, cannot be edited</li>
                    </ul>

                    <h3>Troubleshooting</h3>

                    <h4>Common Issues</h4>
                    <ul>
                        <li><strong>Stream ID already exists:</strong> Choose a different name or load the existing stream to edit it</li>
                        <li><strong>No audio files available:</strong> Upload MP3 files via the Audio Library page first</li>
                        <li><strong>Invalid Stream ID:</strong> Use only letters, numbers, and hyphens (no spaces or special characters)</li>
                        <li><strong>Cover image upload fails:</strong> Check file size (max 5MB) and format (JPG/PNG/GIF)</li>
                        <li><strong>Card creation fails:</strong> Ensure you're logged into your Yoto account</li>
                    </ul>

                    <h3>Tips & Best Practices</h3>
                    <ul>
                        <li>Use descriptive Stream IDs like "bedtime-stories-week1" instead of "stream-abc123"</li>
                        <li>Keep chapter titles concise - they display on small Yoto screens</li>
                        <li>Test streams with the Preview button before creating cards</li>
                        <li>Save your stream before creating a card - you can always create cards later</li>
                        <li>Use consistent naming schemes for related streams (e.g., "story-collection-01", "story-collection-02")</li>
                        <li>Upload cover images that are recognizable at small sizes</li>
                    </ul>

                    <h3>Keyboard Shortcuts</h3>
                    <ul>
                        <li><strong>Escape:</strong> Close any open modal (including this help)</li>
                        <li><strong>/ (forward slash):</strong> Focus the help search box</li>
                    </ul>

                    <h3>Related Documentation</h3>
                    <ul>
                        <li>See the Streams page for managing existing streams</li>
                        <li>Visit Audio Library to upload new audio files</li>
                        <li>Check Yoto Library to view created cards</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/streams.js"></script>
    <script src="/static/js/pwa.js"></script>
    <script>
        // Hide admin nav for non-admin users
        async function checkAdminStatusNav() {
            try {
                const response = await fetch('/api/user/session', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (!data.is_admin) {
                        const adminLink = document.querySelector('a[href="/admin"]');
                        if (adminLink) {
                            adminLink.parentElement.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }
        checkAdminStatusNav();
    </script>
</body>
</html>
