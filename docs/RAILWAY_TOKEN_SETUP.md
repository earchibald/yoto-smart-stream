# Railway Authentication Setup - OAuth-Based Token

## Overview

This project uses **OAuth-based authentication** for Railway CLI access via a single `RAILWAY_API_TOKEN`. This provides a simpler, more secure authentication model compared to per-environment tokens.

**Key Benefits:**

✅ **Simplified Management** - One token for all environments (production, staging, develop, PR environments)  
✅ **OAuth Security** - Uses GitHub OAuth flow, more secure than manually created tokens  
✅ **Automatic Detection** - Railway CLI automatically detects and uses the token  
✅ **Full Permissions** - User-level permissions apply across all projects and environments  
✅ **No Rotation Required** - OAuth tokens are automatically refreshed by Railway

## Authentication Model

Instead of creating separate tokens per environment, this project uses your personal Railway OAuth token extracted from a local login session. This token provides full access to all Railway resources associated with your account.

**Token Location:**
- **Local development**: Stored in `~/.railway/config.json` as `user.token`
- **Cloud Agents**: Stored in GitHub `copilot` environment as `RAILWAY_API_TOKEN`

**How it works:**
1. Login to Railway on your local laptop using OAuth (`railway login --browserless`)
2. Extract the `user.token` from Railway's config file
3. Store it as `RAILWAY_API_TOKEN` in GitHub's `copilot` environment
4. Cloud Agents automatically use this token for all Railway operations

## One-Time Setup

### Step 1: Login to Railway (Local Laptop)

```bash
# Browserless login displays a link to copy/paste
railway login --browserless

# Click the displayed link and authenticate via GitHub OAuth in your browser
# Railway will store your OAuth token in ~/.railway/config.json
```

### Step 2: Extract Token and Set as GitHub Secret

```bash
# Extract token from Railway config and set as GitHub Secret for copilot environment
gh secret set --env copilot RAILWAY_API_TOKEN --body="$(jq -r '.user.token' ~/.railway/config.json)"
```

**That's it!** Cloud Agents can now access Railway using this token.

### Step 3: Verify (Optional)

```bash
# Check the token was set correctly
gh secret list --env copilot

# Should show:
# RAILWAY_API_TOKEN  Updated YYYY-MM-DD
```

## Usage

### Local Development

```bash
# Railway CLI automatically uses credentials from ~/.railway/config.json
railway status
railway logs
railway link
```

### Cloud Agents (GitHub Copilot Workspace)

```bash
# Railway CLI automatically detects RAILWAY_API_TOKEN environment variable
railway login  # Authenticates using RAILWAY_API_TOKEN
railway status  # Works with full access to all environments
```

### All Environments Accessible

With a single `RAILWAY_API_TOKEN`, you have access to:
- **Production** environment (`production` branch)
- **Staging** environment (`staging` branch)
- **Develop** environment (`develop` branch)
- **PR Environments** (feature branches)

The Railway CLI automatically uses this token for all operations across all environments.

## Railway Deployments

**Important**: Deployments are handled automatically by Railway's native GitHub integration, **not** by GitHub Actions.

- **Push to `develop`** → Railway automatically deploys to develop environment
- **Push to `staging`** → Railway automatically deploys to staging environment  
- **Push to `production`** → Railway automatically deploys to production environment
- **Open PR to `develop`** → Railway automatically creates PR environment
- **Close/merge PR** → Railway automatically destroys PR environment

The `RAILWAY_API_TOKEN` is used for **CLI operations only** (logs, status, variables, etc.), not for deployments.

## Security Considerations

### Token Security

✅ **DO:**
- Keep token in GitHub `copilot` environment secrets only
- Use OAuth login on trusted devices
- Monitor Railway audit logs for unauthorized activity
- Re-login and update token if you suspect compromise

❌ **DON'T:**
- Commit `~/.railway/config.json` to git
- Share your Railway OAuth token
- Store token in plain text files
- Use token on untrusted devices

### Why OAuth is More Secure

- **No manual token creation**: Token generated by Railway's secure OAuth flow
- **Automatic refresh**: Railway handles token refresh automatically
- **GitHub-backed**: Uses your GitHub account for authentication
- **Revocable**: Revoke access via GitHub or Railway if needed

## Troubleshooting

### Authentication Failed in Cloud Agent

**Error:** `railway login` fails or `401 Unauthorized`

**Solution:**
1. Verify `RAILWAY_API_TOKEN` is set in `copilot` environment (not repository secrets)
2. Check token value was correctly extracted from `~/.railway/config.json`
3. Re-run setup: `gh secret set --env copilot RAILWAY_API_TOKEN --body="$(jq -r '.user.token' ~/.railway/config.json)"`

### Token Not Working Locally

**Error:** Railway CLI can't authenticate

**Solution:**
1. Run `railway login --browserless` again
2. Complete OAuth flow in browser
3. Verify `~/.railway/config.json` exists and contains `user.token`

### Need to Update Token

**When to update:**
- Changed GitHub account
- Railway requires re-authentication
- Token appears expired or invalid

**How to update:**
1. Run `railway login --browserless` on your local laptop
2. Re-extract and set: `gh secret set --env copilot RAILWAY_API_TOKEN --body="$(jq -r '.user.token' ~/.railway/config.json)"`
3. Existing Cloud Agent sessions may need to be restarted

## Validation Checklist

After setup, verify:

- [ ] Logged in to Railway locally: `railway whoami` shows your username
- [ ] Token extracted: `jq -r '.user.token' ~/.railway/config.json` shows token
- [ ] GitHub secret set: `gh secret list --env copilot` shows `RAILWAY_API_TOKEN`
- [ ] Cloud Agent can authenticate: `railway login` succeeds (in Cloud Agent session)
- [ ] CLI works: `railway status` shows project info

## For Detailed Railway CLI Operations

This document covers authentication setup only. For Railway CLI usage, deployment workflows, and advanced operations, see:

**[railway-service-management skill](/.github/skills/railway-service-management/SKILL.md)**
- [Cloud Agent Authentication](/.github/skills/railway-service-management/reference/cli_scripts.md#cloud-agent-authentication-railway_api_token-mode)
- [Essential Commands](/.github/skills/railway-service-management/reference/cli_scripts.md#essential-commands)
- [Deployment Workflows](/.github/skills/railway-service-management/reference/deployment_workflows.md)
- [Multi-Environment Architecture](/.github/skills/railway-service-management/reference/multi_environment_architecture.md)

---

**Last Updated:** 2026-01-20  
**Authentication Method:** OAuth-based (RAILWAY_API_TOKEN)  
**Security Level:** High
