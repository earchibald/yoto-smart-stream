# Ephemeral Railway Environments - Workflow Diagram

┌─────────────────────────────────────────────────────────────────────────┐
│                        GitHub Repository                                 │
│                    earchibald/yoto-smart-stream                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│   PR Opened   │          │ Push copilot/ │          │ Manual Deploy │
│   (PR #123)   │          │    Branch     │          │ From Codespace│
└───────┬───────┘          └───────┬───────┘          └───────┬───────┘
        │                          │                          │
        ▼                          ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      GitHub Actions Workflows                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────┐    ┌──────────────────┐   ┌─────────────────┐ │
│  │ railway-pr-        │    │ railway-copilot- │   │ Local Script    │ │
│  │ environments.yml   │    │ environments.yml │   │ Execution       │ │
│  └─────────┬──────────┘    └────────┬─────────┘   └────────┬────────┘ │
│            │                        │                       │          │
│            │ Uses RAILWAY_TOKEN     │ Uses RAILWAY_TOKEN    │ Uses     │
│            │ from Repo Secrets      │ from Repo Secrets     │ $RAILWAY_│
│            │                        │                       │ TOKEN    │
└────────────┼────────────────────────┼───────────────────────┼──────────┘
             │                        │                       │
             ▼                        ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│              Railway Platform (railway.app)                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ Ephemeral Environment: pr-123                                    │  │
│  │ ┌────────────┐  ┌──────────┐  ┌────────────┐                   │  │
│  │ │ Web Service│  │PostgreSQL│  │Environment │                   │  │
│  │ │ 512MB RAM  │  │  1GB     │  │ Variables  │                   │  │
│  │ │ 0.5 vCPU   │  │Ephemeral │  │ - DEBUG=true                   │  │
│  │ └────────────┘  └──────────┘  │ - PR_NUMBER=123                │  │
│  │                                │ - YOTO_CLIENT_ID={synced}      │  │
│  │ URL: yoto-pr-123.up.railway.app└────────────┘                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ Ephemeral Environment: copilot-add-feature                       │  │
│  │ ┌────────────┐  ┌────────────┐                                  │  │
│  │ │ Web Service│  │Environment │                                  │  │
│  │ │ 512MB RAM  │  │ Variables  │                                  │  │
│  │ │ 0.5 vCPU   │  │ - DEBUG=true                                  │  │
│  │ └────────────┘  │ - SESSION_TYPE=copilot                        │  │
│  │                 │ - BRANCH_NAME=copilot/add-feature             │  │
│  │ URL: copilot-add-feature.up.railway.app                          │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
            ┌──────────────┐ ┌──────────┐ ┌──────────────┐
            │ PR Commented │ │  Logs    │ │ Health Check │
            │ with URL     │ │Available │ │  /health     │
            └──────────────┘ └──────────┘ └──────────────┘
                    │               
                    ▼               
        ┌─────────────────────┐
        │   Developer Tests   │
        │   Changes in        │
        │   Ephemeral Env     │
        └─────────┬───────────┘
                  │
                  ▼
        ┌─────────────────────┐
        │   PR Closed or      │
        │   Branch Deleted    │
        └─────────┬───────────┘
                  │
                  ▼
        ┌─────────────────────┐
        │   Cleanup Workflow  │
        │   Triggered         │
        └─────────┬───────────┘
                  │
                  ▼
        ┌─────────────────────┐
        │   Environment       │
        │   Destroyed         │
        │   Resources Freed   │
        └─────────────────────┘


# Secret Management Flow

┌─────────────────────────────────────────────────────────────────────────┐
│                    Secret Storage Locations                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────┐      │
│  │ GitHub Repository Secrets                                    │      │
│  │ (Repo Settings → Secrets and variables → Actions)           │      │
│  ├──────────────────────────────────────────────────────────────┤      │
│  │ RAILWAY_TOKEN      - Used by GitHub Actions                 │      │
│  │ YOTO_CLIENT_ID     - Synced to Railway environments         │      │
│  └────────────────────┬─────────────────────────────────────────┘      │
│                       │                                                 │
│                       ▼                                                 │
│            ┌─────────────────────┐                                     │
│            │ GitHub Actions      │                                     │
│            │ Workflows Execute   │                                     │
│            └─────────┬───────────┘                                     │
│                      │                                                  │
│                      ▼                                                  │
│            ┌─────────────────────┐                                     │
│            │ Deploy to Railway   │                                     │
│            │ Set Variables       │                                     │
│            └─────────────────────┘                                     │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────┐      │
│  │ GitHub Codespaces Secrets (User-level)                      │      │
│  │ (User Settings → Codespaces → Secrets)                      │      │
│  ├──────────────────────────────────────────────────────────────┤      │
│  │ RAILWAY_TOKEN      - Personal token for CLI/Scripts         │      │
│  │ YOTO_CLIENT_ID     - Optional, for local testing            │      │
│  └────────────────────┬─────────────────────────────────────────┘      │
│                       │                                                 │
│                       ▼                                                 │
│            ┌─────────────────────┐                                     │
│            │ Codespace Started   │                                     │
│            │ Secrets Injected    │                                     │
│            └─────────┬───────────┘                                     │
│                      │                                                  │
│                      ▼                                                  │
│            ┌─────────────────────┐                                     │
│            │ $RAILWAY_TOKEN      │                                     │
│            │ Available in Shell  │                                     │
│            └─────────┬───────────┘                                     │
│                      │                                                  │
│                      ▼                                                  │
│            ┌─────────────────────┐                                     │
│            │ Scripts & CLI       │                                     │
│            │ Use Token           │                                     │
│            └─────────────────────┘                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘


# Cost Structure

Environment Type     RAM      CPU    Storage   Cost/Hour    Lifecycle
─────────────────────────────────────────────────────────────────────────
PR Environment      512 MB   0.5    1 GB      ~$0.01-0.05  PR open → close
Copilot Environment 512 MB   0.5    1 GB      ~$0.01-0.05  Branch → delete
Staging             512 MB   0.5    5 GB      ~$0.05-0.10  Always running
Production          1 GB     1.0    10 GB     ~$0.15-0.25  Always running

Auto-cleanup ensures zero cost when environments are not active!
