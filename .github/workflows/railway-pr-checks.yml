name: PR Checks with Railway Native Deployment

# This workflow runs tests and checks for PRs
# Railway handles the actual deployment automatically via its GitHub integration
# This workflow only validates the code and tests the deployed environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Run unit tests and linting
  test:
    name: Run Tests and Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run linter (ruff)
        run: ruff check . --exit-zero
        continue-on-error: true
      
      - name: Run formatter check (black)
        run: black --check . --diff
        continue-on-error: true
      
      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=yoto_smart_stream --cov-report=term
        continue-on-error: true
      
      # Note: Railway deployment happens automatically via Railway's GitHub integration
      # No need to use Railway CLI here for deployment

  # Wait for Railway deployment and test it
  integration-test:
    name: Test Railway PR Environment
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set PR environment URL
        id: env-url
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          ENV_URL="https://yoto-smart-stream-pr-${PR_NUMBER}.up.railway.app"
          echo "url=${ENV_URL}" >> $GITHUB_OUTPUT
          echo "PR environment URL: ${ENV_URL}"
      
      - name: Wait for Railway deployment
        run: |
          echo "â³ Waiting for Railway to deploy PR environment..."
          echo "This usually takes 1-2 minutes"
          sleep 90
      
      - name: Test health endpoint
        id: health-check
        continue-on-error: true
        run: |
          URL="${{ steps.env-url.outputs.url }}/health"
          echo "Testing health endpoint: ${URL}"
          
          # Retry health check up to 10 times
          for i in {1..10}; do
            if curl -f -s "${URL}"; then
              echo "âœ… Health check passed"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ Waiting for deployment... (${i}/10)"
            sleep 10
          done
          
          echo "âŒ Health check failed after 10 attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Run integration tests
        if: steps.health-check.outputs.status == 'success'
        run: |
          echo "ðŸ§ª Running integration tests against PR environment"
          # Add integration test commands here when available
          # Example:
          # pytest tests/integration/ --base-url="${{ steps.env-url.outputs.url }}"
      
      - name: Comment PR with deployment info
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const envUrl = '${{ steps.env-url.outputs.url }}';
            const healthStatus = '${{ steps.health-check.outputs.status }}';
            
            const statusEmoji = healthStatus === 'success' ? 'âœ…' : 'âš ï¸';
            const statusText = healthStatus === 'success' ? 'Healthy' : 'Check Failed';
            
            const comment = `## ${statusEmoji} Railway PR Environment Status
            
            **Environment:** \`pr-${prNumber}\`
            **URL:** ${envUrl}
            **Health Check:** ${statusText}
            
            ### Quick Links
            - [ðŸ¥ Health Check](${envUrl}/health)
            - [ðŸ“Š API Docs](${envUrl}/docs)
            - [ðŸ” Railway Dashboard](https://railway.app/dashboard)
            
            ### Testing Commands
            \`\`\`bash
            # View logs
            railway logs -e pr-${prNumber} --tail 100
            
            # Check status
            railway status -e pr-${prNumber}
            
            # Test health endpoint
            curl ${envUrl}/health
            \`\`\`
            
            ### Notes
            - âš¡ Railway automatically deploys on every push
            - ðŸ”„ Environment updates automatically with new commits
            - ðŸ—‘ï¸ Environment will be destroyed when PR is closed/merged
            - âš ï¸ OAuth features won't work (requires static callback URLs)
            
            ---
            _Powered by Railway Native PR Environments â€¢ Auto-deployed by Railway â€¢ Tested by GitHub Actions_`;
            
            // Find existing comment from this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('Railway PR Environment Status')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

  # Optional: Add security scanning or other checks here
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install safety
        run: pip install safety
      
      - name: Run safety check
        run: safety check --json || true
