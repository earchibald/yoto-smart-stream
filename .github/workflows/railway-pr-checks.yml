name: PR Checks with Railway Native Deployment

# This workflow runs tests and checks for PRs
# Railway handles the actual deployment automatically via its GitHub integration
# This workflow only validates the code and tests the deployed environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Run unit tests and linting
  test:
    name: Run Tests and Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run linter (ruff)
        run: ruff check . --exit-zero
        continue-on-error: true
      
      - name: Run formatter check (black)
        run: black --check . --diff
        continue-on-error: true
      
      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=yoto_smart_stream --cov-report=term
        continue-on-error: true
      
      # Note: Railway deployment happens automatically via Railway's GitHub integration
      # No need to use Railway CLI here for deployment

  # Wait for Railway deployment and test it
  integration-test:
    name: Test Railway PR Environment
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      
      - name: Configure PR Environment Variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          YOTO_CLIENT_ID: ${{ secrets.YOTO_CLIENT_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "âš™ï¸ Configuring environment variables for PR environment..."
          
          ENV_NAME="pr-${PR_NUMBER}"
          
          # Note: ENVIRONMENT is now auto-populated from RAILWAY_ENVIRONMENT_NAME (e.g., "pr-123")
          # No need to manually set ENVIRONMENT variable
          
          # Set YOTO_CLIENT_ID if available
          if [ -n "$YOTO_CLIENT_ID" ]; then
            echo "Setting YOTO_CLIENT_ID..."
            railway variables --set YOTO_CLIENT_ID="$YOTO_CLIENT_ID" -e "$ENV_NAME" || echo "Note: Environment may not exist yet"
          else
            echo "âš ï¸ Warning: YOTO_CLIENT_ID not set in GitHub secrets"
          fi
          
          echo "âœ… Environment variables configured"
      
      - name: Set PR environment URL
        id: env-url
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          ENV_URL="https://yoto-smart-stream-pr-${PR_NUMBER}.up.railway.app"
          echo "url=${ENV_URL}" >> $GITHUB_OUTPUT
          echo "PR environment URL: ${ENV_URL}"
      
      - name: Validate PR Environment
        id: validation
        continue-on-error: true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸ” Validating Railway PR Environment..."
          
          # Run validation script with wait flag
          if python scripts/validate_pr_environment.py "${{ steps.env-url.outputs.url }}" --wait --skip-config; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Validation passed"
            exit 0
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Validation failed"
            exit 1
          fi
      
      - name: Run integration tests
        if: steps.validation.outputs.status == 'success'
        run: |
          echo "ðŸ§ª Running integration tests against PR environment"
          # Add integration test commands here when available
          # Example:
          # pytest tests/integration/ --base-url="${{ steps.env-url.outputs.url }}"
      
      - name: Comment PR with deployment info
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const envUrl = '${{ steps.env-url.outputs.url }}';
            const validationStatus = '${{ steps.validation.outputs.status }}';
            
            const statusEmoji = validationStatus === 'success' ? 'âœ…' : 'âš ï¸';
            const statusText = validationStatus === 'success' ? 'All Checks Passed' : 'Validation Failed';
            
            const comment = `## ${statusEmoji} Railway PR Environment Status
            
            **Environment:** \`pr-${prNumber}\`
            **URL:** ${envUrl}
            **Validation:** ${statusText}
            
            ### Environment Configuration
            - âœ… \`RAILWAY_ENVIRONMENT_NAME\` automatically set to \`pr-${prNumber}\`
            - âœ… \`YOTO_CLIENT_ID\` configured from secrets
            
            ### Validation Checks
            - Health endpoint accessibility
            - Root endpoint functionality
            - API documentation availability
            - FastAPI application startup
            
            ### Quick Links
            - [ðŸ¥ Health Check](${envUrl}/api/health)
            - [ðŸ“Š API Docs](${envUrl}/docs)
            - [ðŸ” Railway Dashboard](https://railway.app/dashboard)
            
            ### Testing Commands
            \`\`\`bash
            # Validate PR environment
            python scripts/validate_pr_environment.py ${envUrl}
            
            # View logs
            railway logs -e pr-${prNumber} --tail 100
            
            # Check status
            railway status -e pr-${prNumber}
            
            # Test health endpoint
            curl ${envUrl}/api/health
            \`\`\`
            
            ### Notes
            - âš¡ Railway automatically deploys on every push
            - ðŸ”„ Environment updates automatically with new commits
            - ðŸ—‘ï¸ Environment will be destroyed when PR is closed/merged
            - âš ï¸ OAuth features won't work (requires static callback URLs)
            
            ---
            _Powered by Railway Native PR Environments â€¢ Auto-deployed by Railway â€¢ Validated by GitHub Actions_`;
            
            // Find existing comment from this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('Railway PR Environment Status')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

  # Optional: Add security scanning or other checks here
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install safety
        run: pip install safety
      
      - name: Run safety check
        run: safety check --json || true
