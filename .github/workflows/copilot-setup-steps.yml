# GitHub Copilot Agent Environment Setup
# This file configures the environment for GitHub Copilot coding agents
# Based on .devcontainer/devcontainer.json and setup.sh requirements

steps:
  # Step 1: Install Node.js LTS (required for Railway CLI and AWS CDK)
  - uses: actions/setup-node@v4
    with:
      node-version: 'lts/*'
      
  # Step 2: Install Python 3.11 (matching devcontainer)
  - uses: actions/setup-python@v5
    with:
      python-version: '3.11'
      
  # Step 3: Install GitHub CLI
  - run: |
      if ! command -v gh &> /dev/null; then
        echo "üì¶ Installing GitHub CLI..."
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
        echo "‚úÖ GitHub CLI installed: $(gh --version)"
      else
        echo "‚úÖ GitHub CLI already installed: $(gh --version)"
      fi
    shell: bash
    
  # Step 4: Upgrade pip
  - run: python -m pip install --upgrade pip setuptools wheel
    shell: bash
    
  # Step 5: Install Railway CLI for deployments
  - run: |
      if ! command -v railway &> /dev/null; then
        echo "üì¶ Installing Railway CLI..."
        npm install -g @railway/cli
        if command -v railway &> /dev/null; then
          echo "‚úÖ Railway CLI installed successfully: $(railway --version)"
        else
          echo "‚ö†Ô∏è  Railway CLI installation may have failed"
          exit 1
        fi
      else
        echo "‚úÖ Railway CLI already installed: $(railway --version)"
      fi
    shell: bash
    
  # Step 6: Install AWS CDK for AWS deployments
  - run: |
      if ! command -v cdk &> /dev/null; then
        echo "üì¶ Installing AWS CDK..."
        npm install -g aws-cdk
        if command -v cdk &> /dev/null; then
          echo "‚úÖ AWS CDK installed successfully: $(cdk --version)"
        else
          echo "‚ö†Ô∏è  AWS CDK installation may have failed"
          exit 1
        fi
      else
        echo "‚úÖ AWS CDK already installed: $(cdk --version)"
      fi
    shell: bash
    
  # Step 7: Install Python package with development dependencies
  - run: |
      if [ -f "pyproject.toml" ]; then
        echo "üì¶ Installing package with [dev] dependencies from pyproject.toml..."
        pip install -e .[dev]
      elif [ -f "requirements.txt" ]; then
        echo "üì¶ Installing dependencies from requirements.txt..."
        pip install -r requirements.txt
        
        if [ -f "requirements-dev.txt" ]; then
          echo "üì¶ Installing development dependencies..."
          pip install -r requirements-dev.txt
        fi
      else
        echo "‚ö†Ô∏è  No pyproject.toml or requirements.txt found"
        exit 1
      fi
      echo "‚úÖ Python dependencies installed"
    shell: bash
    
  # Step 8: Install pre-commit hooks if configuration exists
  - run: |
      if [ -f ".pre-commit-config.yaml" ]; then
        echo "üîß Setting up pre-commit hooks..."
        pip install pre-commit
        pre-commit install
        echo "‚úÖ Pre-commit hooks installed"
      else
        echo "‚ÑπÔ∏è  No .pre-commit-config.yaml found, skipping pre-commit setup"
      fi
    shell: bash
    
  # Step 9: Verify Railway authentication (if RAILWAY_API_TOKEN or RAILWAY_TOKEN available)
  - run: |
      if [ -n "$RAILWAY_API_TOKEN" ] || [ -n "$RAILWAY_TOKEN" ]; then
        echo "üîê Verifying Railway authentication..."
        if railway whoami > /dev/null 2>&1; then
          echo "‚úÖ Authenticated to Railway as: $(railway whoami)"
        else
          echo "‚ö†Ô∏è  Railway authentication failed - credentials may be invalid"
        fi
      else
        echo "‚ÑπÔ∏è  RAILWAY_API_TOKEN/RAILWAY_TOKEN not set"
        echo "   Railway MCP tools will have limited functionality"
      fi
    shell: bash
    continue-on-error: true
    
  # Step 10: Verify AWS credentials (if AWS_ACCESS_KEY_ID available)
  - run: |
      if [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
        echo "üîê Verifying AWS credentials..."
        echo "‚úÖ AWS credentials are configured"
        echo "   Region: ${AWS_REGION:-not set, will use default}"
      else
        echo "‚ÑπÔ∏è  AWS credentials not set"
        echo "   AWS CDK deployments will not be available"
      fi
    shell: bash
    continue-on-error: true
    
  # Step 11: Display setup summary
  - run: |
      echo ""
      echo "=================================================="
      echo "‚úÖ GitHub Copilot Agent Environment Ready"
      echo "=================================================="
      echo ""
      echo "üì¶ Installed Tools:"
      echo "  ‚Ä¢ Python: $(python --version)"
      echo "  ‚Ä¢ pip: $(pip --version | head -1)"
      echo "  ‚Ä¢ Node.js: $(node --version)"
      echo "  ‚Ä¢ npm: $(npm --version)"
      echo "  ‚Ä¢ Railway CLI: $(railway --version 2>/dev/null || echo 'not installed')"
      echo "  ‚Ä¢ AWS CDK: $(cdk --version 2>/dev/null || echo 'not installed')"
      echo "  ‚Ä¢ GitHub CLI: $(gh --version | head -1 2>/dev/null || echo 'not installed')"
      echo ""
      echo "üîë Available Secrets:"
      if [ -n "$RAILWAY_API_TOKEN" ] || [ -n "$RAILWAY_TOKEN" ]; then
        echo "  ‚úÖ Railway authentication configured"
      else
        echo "  ‚ö†Ô∏è  Railway authentication NOT configured"
      fi
      if [ -n "$YOTO_CLIENT_ID" ]; then
        echo "  ‚úÖ YOTO_CLIENT_ID configured"
      else
        echo "  ‚ö†Ô∏è  YOTO_CLIENT_ID NOT configured (required for Yoto API)"
      fi
      if [ -n "$AWS_ACCESS_KEY_ID" ]; then
        echo "  ‚úÖ AWS credentials configured"
      else
        echo "  ‚ö†Ô∏è  AWS credentials NOT configured"
      fi
      echo ""
      echo "üìö Quick Commands:"
      echo "  ‚Ä¢ Run tests: pytest"
      echo "  ‚Ä¢ Lint code: ruff check ."
      echo "  ‚Ä¢ Format code: black ."
      echo "  ‚Ä¢ Railway deploy: railway up"
      echo "  ‚Ä¢ AWS CDK deploy: cd infrastructure/cdk && cdk deploy"
      echo ""
      echo "=================================================="
    shell: bash
