name: Railway Copilot Session Environments

# DISABLED: Yoto OAuth requires static callback URLs
# Ephemeral environments with dynamic URLs cannot authenticate
# Use the shared development environment instead with manual coordination

on:
  workflow_dispatch:
    inputs:
      session_id:
        description: 'Session ID (for coordination tracking)'
        required: true
        type: string
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - test
          - status
          - destroy
  # push:
  #   branches:
  #     - 'copilot/**'
  # delete:
  #   branches:
  #     - 'copilot/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Deploy Copilot session environment
  deploy-copilot-environment:
    name: Deploy Copilot Environment
    runs-on: ubuntu-latest
    # Run on push to copilot branches or manual deploy action
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/copilot/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run quick validation
        run: |
          ruff check . --exit-zero || true
          pytest tests/ -v --tb=short -x || true
        continue-on-error: true
      
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      
      - name: Generate environment name
        id: env-name
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV_NAME="${{ github.event.inputs.session_id }}"
          else
            # Extract branch name and create environment name
            BRANCH_NAME="${{ github.ref_name }}"
            # Convert copilot/feature-name to copilot-feature-name
            ENV_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
            # Limit length to 63 characters (Railway limit)
            ENV_NAME=$(echo "$ENV_NAME" | cut -c1-63)
          fi
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Deploying to environment: $ENV_NAME"
      
      - name: Deploy to Railway Copilot Environment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          YOTO_CLIENT_ID: ${{ secrets.YOTO_CLIENT_ID }}
        run: |
          echo "üöÄ Deploying to Railway Copilot environment: ${{ steps.env-name.outputs.env_name }}"
          
          # Use ephemeral environment script
          chmod +x ./scripts/railway_ephemeral_env.sh
          ./scripts/railway_ephemeral_env.sh deploy ${{ steps.env-name.outputs.env_name }}
      
      - name: Configure Copilot Environment Variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          YOTO_CLIENT_ID: ${{ secrets.YOTO_CLIENT_ID }}
        run: |
          echo "‚öôÔ∏è Setting environment variables for Copilot environment..."
          
          ENV_NAME="${{ steps.env-name.outputs.env_name }}"
          
          # Set environment type
          railway variables set ENVIRONMENT="copilot-preview" -e "$ENV_NAME"
          railway variables set DEBUG="true" -e "$ENV_NAME"
          railway variables set LOG_LEVEL="debug" -e "$ENV_NAME"
          
          # Set session metadata
          railway variables set SESSION_TYPE="copilot" -e "$ENV_NAME"
          railway variables set BRANCH_NAME="${{ github.ref_name }}" -e "$ENV_NAME"
          railway variables set GIT_SHA="${{ github.sha }}" -e "$ENV_NAME"
          
          # Sync Yoto API credentials if available
          if [ -n "$YOTO_CLIENT_ID" ]; then
            railway variables set YOTO_CLIENT_ID="$YOTO_CLIENT_ID" -e "$ENV_NAME"
          fi
      
      - name: Get deployment status
        if: always()
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üìä Deployment status:"
          railway status -e ${{ steps.env-name.outputs.env_name }} || echo "Could not fetch status"
          
          echo ""
          echo "üìã Recent logs:"
          railway logs -e ${{ steps.env-name.outputs.env_name }} --tail 30 || echo "Could not fetch logs"
      
      - name: Save deployment info
        run: |
          ENV_NAME="${{ steps.env-name.outputs.env_name }}"
          echo "Environment deployed: $ENV_NAME"
          echo "Access via: railway open -e $ENV_NAME"
          echo ""
          echo "To test locally, ensure RAILWAY_TOKEN is set in Codespaces secrets"

  # Test Copilot session environment
  test-copilot-environment:
    name: Test Copilot Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'test'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      
      - name: Test environment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          ENV_NAME="${{ github.event.inputs.session_id }}"
          echo "üß™ Testing Copilot environment: $ENV_NAME"
          
          chmod +x ./scripts/railway_ephemeral_env.sh
          ./scripts/railway_ephemeral_env.sh test "$ENV_NAME"

  # Get status of Copilot session environment
  status-copilot-environment:
    name: Check Copilot Environment Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'status'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      
      - name: Get status
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          ENV_NAME="${{ github.event.inputs.session_id }}"
          echo "üìä Status for Copilot environment: $ENV_NAME"
          
          chmod +x ./scripts/railway_ephemeral_env.sh
          ./scripts/railway_ephemeral_env.sh status "$ENV_NAME"

  # Cleanup Copilot session environment
  cleanup-copilot-environment:
    name: Cleanup Copilot Environment
    runs-on: ubuntu-latest
    # Run on branch deletion or manual destroy action
    if: |
      (github.event_name == 'delete' && startsWith(github.event.ref, 'copilot/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      
      - name: Generate environment name
        id: env-name
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV_NAME="${{ github.event.inputs.session_id }}"
          else
            # Extract branch name from deleted branch
            BRANCH_NAME="${{ github.event.ref }}"
            ENV_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
            ENV_NAME=$(echo "$ENV_NAME" | cut -c1-63)
          fi
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Cleaning up environment: $ENV_NAME"
      
      - name: Destroy Copilot Environment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üóëÔ∏è Destroying Railway Copilot environment: ${{ steps.env-name.outputs.env_name }}"
          
          chmod +x ./scripts/railway_ephemeral_env.sh
          ./scripts/railway_ephemeral_env.sh destroy ${{ steps.env-name.outputs.env_name }} || echo "Environment may have already been cleaned up"
      
      - name: Confirm cleanup
        run: |
          echo "‚úÖ Copilot environment ${{ steps.env-name.outputs.env_name }} has been cleaned up"
          echo "Resources have been released"
